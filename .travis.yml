language: rust
cache: cargo

dist: trusty
sudo: required

os:
  - linux
  - osx

rust:
  - nightly
  - beta
  - stable

addons:
  apt:
    packages:
      - libcurl4-openssl-dev
      - libelf-dev
      - libdw-dev
      - cmake
      - gcc
      - binutils-dev

before_script:
  - rustup component add rustfmt-preview
  - cargo fmt --version

script:
  - cd Connect6
  - if [[ "$TRAVIS_RUST_VERSION" == "stable" ]]; then echo "start fmt"; cargo fmt --all -- --check; fi;
  - cargo build --verbose
  - cargo test --verbose

after_success: |-
  # codecov
  if [[ "$TRAVIS_OS_NAME" == "linux" && "$TRAVIS_RUST_VERSION" == "stable" ]]; then
    wget https://github.com/SimonKagstrom/kcov/archive/master.tar.gz &&
    tar xzf master.tar.gz &&
    cd kcov-master &&
    mkdir build &&
    cd build &&
    cmake .. &&
    make &&
    sudo make install &&
    cd ../.. &&
    rm -rf kcov-master &&
    for file in target/debug/connect6-*[^\.d]; do
      mkdir -p "target/cov/$(basename $file)";
      kcov --exclude-pattern=/.cargo,/usr/lib --verify "target/cov/$(basename $file)" "$file";
    done &&
    for file in target/debug/sample-*[^\.d]; do
      mkdir -p "target/cov/$(basename $file)";
      kcov --exclude-pattern=/.cargo,/usr/lib --verify "target/cov/$(basename $file)" "$file";
    done &&
    bash <(curl -s https://codecov.io/bash) &&
    echo "Uploaded code coverage"
  fi &&
  # doc github-pages
  [ $TRAVIS_BRANCH = master ] &&
  [ $TRAVIS_PULL_REQUEST = false ] &&
  cargo doc &&
  echo "<meta http-equiv=refresh content=0;url=connect6/index.html>" > target/doc/index.html &&
  sudo pip install ghp-import &&
  ghp-import -n target/doc &&
  git push -fq https://${GH_TOKEN}@github.com/${TRAVIS_REPO_SLUG}.git gh-pages

env:
  global:
    secure: JWU99oGmw1y0yDGCHvo2dB2GMtQvzivjD7oAduJgGPB5tUPdIyrx6Z1+0GrEQdTJdOYkKPtDcllok47i8ocNcMUdOgRIQ5h8nBq5FB943OwiiwqG6Jrn4JBPdj4EO3MSuTphKEivgmHVXY2FWXSoTw93OGAcupTCGRs38Tfybg3fZPXQBqUwAzA9CZrHkgjr12tQdsRoQfpYt32Iv1GT2E+tVcosVzsN6NyT7Ju7OACexEE1oh5KTMEKjwhjJDjPQBm9CNzzBfutlgolYvPzq6lRhksDlALVYa4kEVMyI/ZmXGF5jDDzdL6gV7Rx5xvheCSEEJQ3t3sKxFROdKrPZ72w38PNXzq5k3BXWoEm0HId+VfAIPy1LOFeukdnkdvFRPHAUS5Zv+edLswRjj7nzJbi/1prLhztTX90Ui8WSoPED84c4Q03ksiQhpH4xQ9KmIGQLfTfjAok81lV+jCPMnW3bnDmvQ5tHqBU13i7nNM8quOaTHwC0wL3J2dRHHqlyeOPM10+9WBNDZluAcfFgCrTpUI2G2TL4PFOVYE4TGk3HK0h9k71XmMUWXVthEuYlastwmLb2vKD6pmWNYHJLyj8t0wpm5AXQA7E/TWe2dg4lFzQNeSE70rf3ZWVV458soQD2C+vigWyedsDLtxR5xqPxLqxl5u5XIqzA90Ncw8=
